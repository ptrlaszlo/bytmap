<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bytmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">
  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
  <style>
    html,body{
      height: 100%;
      margin: 0;
      padding: 0;
    }
    div#map {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <form id="filter">
    <input type="text" name="areaMin" id="areaMin" placeholder="min area">
    <input type="text" name="areaMax" id="areaMax" placeholder="max area">
    <input type="text" name="priceMin" id="priceMin" placeholder="min price">
    <input type="text" name="priceMax" id="priceMax" placeholder="max price">
    <input type="submit" value="Filter" onclick="readApartments();return false;">
  </form>
  <div id="map"></div>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDZCVFKq4RqoHvCLPUzbmyFRw8eGOPiOGc&callback=initMap" type="text/javascript"></script>
  <script>
    let map = undefined;
    let infowindow = undefined;
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: {lat: 48.143, lng: 17.107},
        disableDefaultUI: true,
        zoomControl: true
      });
      infowindow = new google.maps.InfoWindow();

      map.addListener('dragend', function(){ readApartments(); });
      map.addListener('zoom_changed', function(){ readApartments(); });

      google.maps.event.addListenerOnce(map, 'idle', function(){
        readApartments();
      });
    }

    function isNumeric(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    }

    function readApartments() {
      const bounds = map.getBounds();
      if (bounds) {
        let numericParams = '';
        const areaMin = document.getElementById('areaMin').value;
        if (isNumeric(areaMin)) { numericParams += `&areaMin=${areaMin}` }
        const areaMax = document.getElementById('areaMax').value;
        if (isNumeric(areaMax)) { numericParams += `&areaMax=${areaMax}` }
        const priceMin = document.getElementById('priceMin').value;
        if (isNumeric(priceMin)) { numericParams += `&priceMin=${priceMin}` }
        const priceMax = document.getElementById('priceMax').value;
        if (isNumeric(priceMax)) { numericParams += `&priceMax=${priceMax}` }

        const nelat = bounds.getNorthEast().lat();
        const nelon = bounds.getNorthEast().lng();
        const swlat = bounds.getSouthWest().lat();
        const swlon = bounds.getSouthWest().lng();
        const opts = { method: 'GET', headers: {} };
        const params = `latTop=${nelat}&latBottom=${swlat}&lonWest=${swlon}&lonEast=${nelon}` + numericParams;
        console.log(params);
        fetch(`https://fozix1n9gl.execute-api.eu-west-1.amazonaws.com/dev/apartments?${params}`, opts).then(function (response) {
          return response.json();
        }).then(function (body){
          plotMarkers(body);
        });
      }
    }

    function generateContent(item) {
      return `
        <a target="_blank" href="${item.link}" style="text-decoration:none;">
        <img src="${item.image}" style="float: left;padding-right:5px;"><br>
        ${item.title}<br><br>
        â‚¬${parseInt(item.price)}, ${item.area}m<sup>2</sup>
        </a>
      `;
    }

    let markersMap = new Map();
    function plotMarkers(result) {
      infowindow.close();
      let newMarkers = new Map();
      result.forEach(function (item) {
        const marker = markersMap.get(item.link);
        if (marker) {
          marker.infowindow.setContent(generateContent(item));
          newMarkers.set(item.link, marker);
        } else {
          const marker = new google.maps.Marker({
            position: {lat: item.location.lat, lng: item.location.lon},
            map: map
          });
          marker.infowindow = infowindow;
          marker.addListener('click', function() {
            infowindow.setContent(generateContent(item));
            infowindow.open(map, marker);
          });
          newMarkers.set(item.link, marker);
        }
      });

      markersMap.forEach(function (marker, id) {
        // remove markers which are not visible any more
        if (!newMarkers.get(id)) {
          marker.setMap(null);
        }
      });
      markersMap = newMarkers;
    }
  </script>
</body>
</html>